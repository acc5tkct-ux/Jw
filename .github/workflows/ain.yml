name: "ğŸš€ RDP - ngancute Premium"

on:
  workflow_dispatch:
    inputs:
      duration:
        description: "Thá»i gian sá»­ dá»¥ng"
        required: true
        default: "1_Giá»_(60m)"
        type: choice
        options:
          - "30_PhÃºt_(30m)"
          - "1_Giá»_(60m)"
          - "1_Giá»_30_PhÃºt_(90m)"
          - "2_Giá»_(120m)"
          - "3_Giá»_(180m)"
          - "4_Giá»_(240m)"
          - "6_Giá»_(360m)"

jobs:
  Setup-RDP:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

      - name: Init UTF-8
        run: chcp 65001

      - name: Banner
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "==========================================="
          Write-Host " ğŸš€ RDP Premium - ngancute"
          Write-Host " â³ Thá»i gian: ${{ github.event.inputs.duration }}"
          Write-Host "==========================================="

      - name: Enable RDP + Firewall
        shell: powershell
        run: |
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v SecurityLayer /t REG_DWORD /d 0 /f
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-Out" dir=out action=allow protocol=TCP localport=3389
          Start-Service TermService

      - name: Create Premium User
        shell: powershell
        run: |
          $user = "ngancute"
          $pass = "ngan@1212"
          $secure = ConvertTo-SecureString $pass -AsPlainText -Force

          if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
            Remove-LocalUser -Name $user -ErrorAction SilentlyContinue
          }

          New-LocalUser -Name $user -Password $secure -Description "Premium RDP Account"
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user

          echo "RDP_USER=$user" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: Show Login Info
        shell: powershell
        run: |
          $ip = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {
            $_.IPAddress -notlike "169.*" -and $_.IPAddress -ne "127.0.0.1"
          })[0].IPAddress

          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host " ğŸ‰ RDP READY!"
          Write-Host " ğŸŒ IP:   $ip"
          Write-Host " ğŸ‘¤ User: $env:RDP_USER"
          Write-Host " ğŸ”‘ Pass: $env:RDP_PASS"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Keep Alive
        shell: powershell
        run: |
          $d = "${{ github.event.inputs.duration }}"
          switch ($d) {
            "30_PhÃºt_(30m)" { $m = 30 }
            "1_Giá»_(60m)" { $m = 60 }
            "1_Giá»_30_PhÃºt_(90m)" { $m = 90 }
            "2_Giá»_(120m)" { $m = 120 }
            "3_Giá»_(180m)" { $m = 180 }
            "4_Giá»_(240m)" { $m = 240 }
            "6_Giá»_(360m)" { $m = 360 }
            default { $m = 60 }
          }

          $end = (Get-Date).AddMinutes($m)
          Write-Host "â³ Runner sáº½ cháº¡y tá»›i: $end"

          while ((Get-Date) -lt $end) {
            Start-Sleep 60
          }
